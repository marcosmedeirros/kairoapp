<div class="header-row">
  <h2>Finanças</h2>
  <div class="month-filter">
    <label for="month">Mês:</label>
    <input id="month" type="text" inputmode="numeric" pattern="\\d{4}-\\d{2}" placeholder="AAAA-MM" [(ngModel)]="month" (change)="onMonthChange()" title="Digite no formato AAAA-MM (ex: 2025-10)" />
  </div>
  <div class="spacer"></div>
</div>

<!-- Lista de meses disponíveis -->
<div class="months-list" *ngIf="availableMonths.length > 0">
  <button 
    *ngFor="let m of availableMonths" 
    class="month-chip"
    [class.active]="month === m"
    (click)="selectMonth(m)"
    [title]="'Filtrar por ' + (m | monthNamePt)">
    {{ m | monthNamePt }}
  </button>
</div>

<div class="grid cards">
  <div class="card success">
    <div class="card-title">Entradas</div>
    <div class="card-value">{{ summary?.income | number:'1.2-2' }}</div>
  </div>
  <div class="card danger">
    <div class="card-title">Saídas</div>
    <div class="card-value">{{ summary?.expense | number:'1.2-2' }}</div>
  </div>
  <div class="card accent">
    <div class="card-title">Saldo</div>
    <div class="card-value">{{ summary?.balance | number:'1.2-2' }}</div>
  </div>
  <div class="card info">
    <div class="card-title">Mês</div>
    <div class="card-value">{{ month | monthNamePt }}</div>
  </div>
  
</div>

<div class="grid two-cols">
  <!-- Adicionar transação -->
  <div class="card">
    <h3>Adicionar lançamento</h3>
    <div class="form-grid">
      <label>Data
        <input type="date" [(ngModel)]="newTransaction.date"/>
      </label>
      <label>Valor
        <input type="number" step="0.01" [(ngModel)]="newTransaction.amount" placeholder="0,00"/>
      </label>
      <label>Tipo
        <select [(ngModel)]="newTransaction.type" title="Tipo da transação">
          <option value="INCOME">Entrada</option>
          <option value="EXPENSE">Saída</option>
        </select>
      </label>
      <label>Categoria
        <select [(ngModel)]="newTransaction.categoryId" title="Categoria">
          <option [ngValue]="null" disabled>Selecione...</option>
          <option *ngFor="let c of categories" [ngValue]="c.id">{{ c.name }}</option>
        </select>
      </label>
      <label class="full">Descrição
        <input type="text" [(ngModel)]="newTransaction.description" placeholder="Opcional"/>
      </label>
      <div class="actions">
        <button class="btn primary" (click)="addTransaction()">Adicionar</button>
      </div>
    </div>
  </div>

  <!-- Categorias -->
  <div class="card">
    <h3>Categorias</h3>
    <div class="inline-form">
      <input type="text" [(ngModel)]="newCategory.name" placeholder="Nova categoria"/>
      <button class="btn" (click)="addCategory()">Adicionar</button>
    </div>
    <ul class="list">
      <li *ngFor="let c of categories">
        <span *ngIf="editingCategoryId !== c.id">{{ c.name }}</span>
        <input *ngIf="editingCategoryId === c.id" type="text" [(ngModel)]="editedCategory.name" class="edit-input" placeholder="Nome da categoria" title="Editar nome da categoria"/>
        <div class="actions-inline">
          <button *ngIf="editingCategoryId !== c.id" class="icon-btn edit" (click)="startEditCategory(c)" title="Editar categoria">✏️</button>
          <button *ngIf="editingCategoryId === c.id" class="icon-btn save" (click)="saveEditCategory(c)" title="Salvar">✅</button>
          <button *ngIf="editingCategoryId === c.id" class="icon-btn cancel" (click)="cancelEditCategory()" title="Cancelar">❌</button>
          <button *ngIf="editingCategoryId !== c.id" class="icon-btn delete" (click)="openDeleteCategory(c)" title="Remover categoria">🗑️</button>
        </div>
      </li>
    </ul>
  </div>
</div>

<!-- Lista de transações do mês -->
<div class="card">
  <h3>Lançamentos do mês</h3>
  <div class="table">
    <div class="table-header">
      <div>Data</div>
      <div>Tipo</div>
      <div>Categoria</div>
      <div>Descrição</div>
      <div class="right">Valor</div>
      <div>Ações</div>
    </div>
    <div class="table-row" *ngFor="let t of transactions">
      <div *ngIf="editingTransactionId !== t.id">{{ t.date | datePt }}</div>
      <input *ngIf="editingTransactionId === t.id" type="date" [(ngModel)]="editedTransaction.date" class="edit-input-small" title="Data da transação"/>
      
      <div *ngIf="editingTransactionId !== t.id">
        <span [class.badge-success]="t.type==='INCOME'" [class.badge-danger]="t.type==='EXPENSE'" class="badge">{{ t.type==='INCOME' ? 'Entrada' : 'Saída' }}</span>
      </div>
      <select *ngIf="editingTransactionId === t.id" [(ngModel)]="editedTransaction.type" class="edit-input-small" title="Tipo da transação">
        <option value="INCOME">Entrada</option>
        <option value="EXPENSE">Saída</option>
      </select>
      
      <div *ngIf="editingTransactionId !== t.id">{{ t.category?.name }}</div>
      <select *ngIf="editingTransactionId === t.id" [(ngModel)]="editedTransaction.categoryId" class="edit-input-small" title="Categoria">
        <option *ngFor="let c of categories" [ngValue]="c.id">{{ c.name }}</option>
      </select>

      <div *ngIf="editingTransactionId !== t.id" class="description-cell">{{ t.description || '-' }}</div>
      <input *ngIf="editingTransactionId === t.id" type="text" [(ngModel)]="editedTransaction.description" class="edit-input-small" title="Descrição" placeholder="Opcional"/>
      
      <div *ngIf="editingTransactionId !== t.id" class="right">{{ t.amount | number:'1.2-2' }}</div>
      <input *ngIf="editingTransactionId === t.id" type="number" step="0.01" [(ngModel)]="editedTransaction.amount" class="edit-input-small right" title="Valor" placeholder="0,00"/>
      
      <div class="actions-inline">
        <button *ngIf="editingTransactionId !== t.id" class="icon-btn edit" (click)="startEditTransaction(t)" title="Editar transação">✏️</button>
        <button *ngIf="editingTransactionId === t.id" class="icon-btn save" (click)="saveEditTransaction(t)" title="Salvar">✅</button>
        <button *ngIf="editingTransactionId === t.id" class="icon-btn cancel" (click)="cancelEditTransaction()" title="Cancelar">❌</button>
        <button *ngIf="editingTransactionId !== t.id" class="icon-btn delete" (click)="openDeleteTransaction(t)" title="Excluir transação">🗑️</button>
      </div>
    </div>
  </div>
</div>

<!-- Despesas por categoria -->
<div class="card">
  <h3>Despesas por categoria</h3>
  <ul class="list">
    <li *ngFor="let item of summary?.byCategory">
      <span>{{ item.categoryName }}</span>
      <span class="right">{{ item.total | number:'1.2-2' }}</span>
    </li>
  </ul>
  <div *ngIf="!summary?.byCategory || summary.byCategory.length === 0" class="muted">Sem despesas neste mês.</div>
  
</div>

<!-- Modal de confirmação de deleção -->
<div class="modal" *ngIf="showDeleteModal">
  <div class="modal-content">
    <p>Tem certeza que deseja remover este item?</p>
    <div class="modal-actions">
      <button class="btn" (click)="closeDeleteModal()">Cancelar</button>
      <button class="btn danger" (click)="confirmDelete()">Remover</button>
    </div>
  </div>
</div>
